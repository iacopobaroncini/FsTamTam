<!--

    ------------------------------------------
    FsTamTam

    (c) Iacopo Baroncini. All rights reserved.
    ------------------------------------------

    Redistribution and use in source and binary forms, with or without modification,
    are permitted provided that the following conditions are met:

    1)  Redistributions of source code must retain the above copyright notice, this list
    of conditions and the following disclaimer.

    2)  Redistributions in binary form must reproduce the above copyright notice, this
    list of conditions and the following disclaimer in the documentation and/or other
    materials provided with the distribution.

    3)  Neither the name of Iacopo Baroncini nor the names of its contributors may be
    used to endorse or promote products derived from this software without specific
    prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
    AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
    WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
    IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
    INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
    NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
    OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
    WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
    ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY
    OF SUCH DAMAGE.

-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>FsTamTam Console</title>
    <script src="/js/FsTamTam.js"></script>
    <script src="/js/FsTamTamGlobalVariables.js"></script>
    <script src="/js/SimConnectVariables.js"></script>
    <script src="/js/SimConnectEvents.js"></script>
    <script src="/js/PmdgNgxMouseFlags.js"></script>
    <script src="/js/PmdgNgxVariables.js"></script>
    <script src="/js/PmdgNgxEvents.js"></script>
    <script src="/js/FsTamTamCduScreenData.js"></script>
    <style type="text/css">

        @font-face {
          font-family: 'PressStart2P-Regular';
          src: url('/fonts/PressStart2P-Regular.eot?#iefix') format('embedded-opentype'),  url('/fonts/PressStart2P-Regular.woff') format('woff'), url('/fonts/PressStart2P-Regular.ttf')  format('truetype'), url('/fonts/PressStart2P-Regular.svg#PressStart2P-Regular') format('svg');
          font-weight: normal;
          font-style: normal;
        }            

        html { font-family:"Arial"; font-size:100%; font-size:12px; cursor:default; }
        html, body, input { margin:0; padding:0; color:white; background-color:black; }
        td { vertical-align:top; }
        h2 { margin-top:30px; color:white; }
        input, select { outline: none; border:1px #888 solid; border-radius: 4px; padding:2px 5px; background-color:#666; color:white; }
        table { border-spacing: 0px; border-collapse: separate; }
        input:focus, select focus { border:1px #fff solid; background-color: #888; }
        
        #logo { position:fixed; left:20px; top:20px; z-index:100; }
        #logo img { width:200px; }
        #logolabel { color:#ffffff66; padding-top:10px; }
        
        .state { padding-top:0px; padding-left:220px; }
        .state td { vertical-align:middle !important; }
        .state th span { padding:10px 14px; text-align:center; background-color:#32323c; border:1px #fff solid; border-radius:25px; }
        .state td { text-align: center; }
        .state td:nth-child(1) { max-width:150px; min-width:150px; }
        .state th:nth-child(2) { font-size:250%; color:#ffffff66; }
        .state td:nth-child(3) { max-width:150px; min-width:150px; }
        .state th:nth-child(4) { font-size:250%; color:#ffffff66; }
        .state td:nth-child(5) { max-width:150px; min-width:150px; }
        .statecnt { padding:20px; padding-bottom:0;}
        .state td div:nth-child(1) { font-weight:bold; }
        .state td div:nth-child(2) { height:25px; }

        .hl { color:aqua; }
        
        #page { background-color:black; padding:0; min-width:800px; }
        #header { position: fixed; top:0; left:0; background-color: #32323c; width:100%; min-width:800px; border-bottom:1px black solid; }
        #menu { padding: 10px; padding-bottom:0; padding-top:10px; background-color:#32323c; }
        #menu table { padding:0; margin:0; border-spacing: 10px 0px; border-collapse: separate; }
        #menu th { padding-bottom:7px; }
        #menu th div { color:#ffffff66; padding:3px 0px; border:1px #ffffff66 solid; border-bottom:0; border-radius:7px 7px 0px 0px; }
        #menu td { margin-left:2px; background-color: #ffffff22; padding:8px 10px; text-decoration: none; color:white; cursor:pointer;
            font-weight:bold; border:0; text-align:center; vertical-align:middle;
            border-radius:6px 6px 0px 0px; }
        #menu .selected { background-color:black; color:orange; }
        #menu td:hover { color:orange; }
        #menu .disabled, #menu .disabled:hover { color:#ffffff44; cursor:default; background-color: #00000044; }
        
        #toolscnt { background-color: black; padding-top:20px; }
        #toolscnt a { margin-left:25px; background-color:white; border-radius: 4px; padding:4px 8px; text-decoration: none; color:black; cursor: pointer; }
        #toolscnt a:hover { background-color: #f90; }
        #toolscnt img { width:18px; vertical-align: middle; margin-right:5px;}
        #toolscnt span { margin-left:25px; color:#aaa; }
        #toolscnt table { width:100vw; }
        #toolscnt table td { vertical-align:middle; }
        #toolscnt table td:nth-child(1) { padding-left:25px; }
        #toolscnt table td:nth-child(2) { text-align:right; padding-right:30px; }
        #toolscnt .showall::before { content: "⬤\00A0\00A0"; color:#0f0; }
        #toolscnt .showsome::before { content: "⬤\00A0\00A0"; color:#00000030; }
        #tools { padding-bottom:15px; min-width:800px; border-bottom:2px white solid; }
        
        #content { padding-bottom:100px; min-width:800px;}
        
        .system-info { margin-left:20px; color:#aaa; }
        .system-info td:nth-child(2) { padding-left:20px; color:white; }
        .system-info tr td hr { border:0px; background-color:#666; height:1px; }

        .list { background-color:#222; }
        .list th { text-align:left; color:black; background-color:white; padding:10px 5px; }
        .list td { border-bottom:1px #ffffff60 solid; padding:5px 5px; color:#aaa; }
        .list .arraylabel { font-weight:normal; color:#aaa !important;}
        .list td:nth-child(1) { color:#ffffff00; } 
        .list td:nth-child(2) { min-width:400px; max-width:400px; font-weight:bold; }
        .list td:nth-child(2) span { color:white; }
        .list td:nth-child(2) span:hover { color:orange; cursor:pointer; }
        .list td:nth-child(3) { min-width:500px; max-width:500px; }
        .list .probe td:nth-child(1) { color:#0f0; } 
        .list .probe td:nth-child(2) span { color:#0f0; } 
        .list .probe td:nth-child(2) span:hover { color:orange; } 
        .list .phint { color:yellow; font-family:"Lucida Console", Monaco, monospace; }

        .listops { background-color:#222; }
        .listops>tbody>tr>th { text-align:left; color:white; background-color:#666; padding:10px 5px; font-weight:bold; }
        .listops>tbody>tr>td { border-bottom:1px #ffffff60 solid; padding:5px 5px; color:#aaa; }
        .listops>tbody>tr>td:nth-child(1) span { color:#0f0; } 
        .listops>tbody>tr>td:nth-child(2) { min-width:400px; max-width:400px; font-weight:bold; }
        .listops>tbody>tr>td:nth-child(2) span { color:#0f0; }
        .listops>tbody>tr>td:nth-child(2):hover { color:orange; cursor:pointer; }
        .listops>tbody>tr>td:nth-child(2) span:hover { color:orange; cursor:pointer; }
        .listops>tbody>tr>td:nth-child(3) { min-width:500px; max-width:500px; }
        .listops>tbody>tr>td:nth-child(4) { min-width:300px; max-width:300px; }
        .listops .arraylabel { font-weight:normal; color:#aaa !important; }
        .listops .param { min-width:200px; }
        .listops .param input { width:75px; }
        .listops .param input:focus { color:aqua; }
        .listops .param a { margin-left:10px; background-color:white; padding:4px 5px 4px 7px; border:0; border-radius:11px; color:black; cursor:pointer }
        .listops .param a:hover { background-color:orange; }
         //.listops .value { color: aqua; font-family:"Lucida Console", Monaco, monospace; } 
        .listops .valuestring:before { content:"\201c"; color:#aaa; }
        .listops .valuestring:after { content:"\201d"; color:#aaa; }
        .listops .red { color:#f44; }
        .listops .green { color:#4a4; }
        .listvars>tbody>tr>td:nth-child(3) { font-family:"Lucida Console", Monaco, monospace; } 
        .listglobals>tbody>tr>td:nth-child(4) { font-family:"Lucida Console", Monaco, monospace; color:aqua; } 
        
        .specialnote { color : #ff0 !important; }
        .noprobes { padding-left:10px; }
        .h2ops { color:orange; color:white; margin-top:30px; }

        .cduscreen { font-family:"PressStart2P-Regular", monospace; border:1px aqua solid; color:white; background-color:black; }
        .cduscreen td { width:13px; height:16px; padding:0; margin:0; text-align:center; vertical-align:bottom; color:white; font-size:10px; }
        .cduscreen .cduColor0 { color:white; }
        .cduscreen .cduColor1 { color:cyan; }
        .cduscreen .cduColor2 { color:limegreen; }
        .cduscreen .cduColor3 { color:magenta; }
        .cduscreen .cduColor4 { color:orange; }
        .cduscreen .cduColor5 { color:red; }
        .cduscreen .cduSmallFont { font-size:7px; }
        .cduscreen .cduReverse { background-color:white; color:black;}
        .cduscreen .cduDimmed { color:#666;}
        .cduscreen td img { width:9px; }
        
        .label { padding:20px 20px; color:#aaa; }
        .log { padding:2px 20px; font-family:"Lucida Console", Monaco, monospace; }
        
        .hide { display:none; }
        
        #listsmenu {padding:30px 0px 20px 10px; }
        
        #datalists { padding-bottom:100px; min-width:800px; padding-top:200px; }
        #datalists table { background-color:#222; }
        #datalists th { text-align:left; color:black; background-color:white; padding:10px 5px; font-weight:bold; }
        #datalists td { border-bottom:1px #ffffff60 solid; padding:5px 5px; color:#aaa; }
        #datalists td:nth-child(1) { min-width:150px; max-width:150px; color:white; font-weight:bold; padding-left:10px; } 
        #datalists td:nth-child(2) { min-width:700px; max-width:700px; font-family:"Lucida Console", Monaco, monospace; }
        #datalists td:nth-child(3) { color:yellow; font-family:"Lucida Console", Monaco, monospace; }
        #datalists a { background-color:white; padding:4px 10px; border:0; border-radius:11px; color:black; margin-right:10px;
            cursor:pointer;font-weight:bold; }
        #datalists a:hover { background-color:orange; }
        #datalists .listele { background-color:#333; padding:5px 5px; margin:5px 0px; }

        .value { color:aqua; }
        
    </style>
    <script language="javascript">
        
            var width = 0;
            var height = 0;
            var tableName = "";
            var refTools = null;
            var refContent = null;
            var refSearch = null;
            var refShowMode = null;

            const __NONE = -1;
            const __SYSTEM_INFO = 0;
            const __GLOBAL_VARIABLES = 1;
            const __SIMCONNECT_VARIABLES = 2;
            const __SIMCONNECT_EVENTS = 3;
            const __PMDG_NGX_VARIABLES = 4;
            const __PMDG_NGX_EVENTS = 5;
            const __OPERATIONS = 6;
            const __LISTS = 7;
            var state = __NONE;
            var simulator = "";
            var showProbesOnly = false;
            var simulationRunning = false;
            var connected = false;
            var systemInfoInterval = -1;
            var systemLogInterval = -1;
            var simulatorNameInterval = -1;
            var mouseEvents;
            var reqs;
            var refDataLists = null;
        
            mouseEvents = '<option value="0" selected>None</option>';
            mouseEvents += '<optgroup label="Left">';
            mouseEvents += '<option value="' + 0x20000000 + '">Left single</option>';
            mouseEvents += '<option value="' + 0x04000000 + '">Left double</option>';
            mouseEvents += '<option value="' + 0x00800000 + '">Left drag</option>';
            mouseEvents += '<option value="' + 0x00020000 + '">Left release</option>';
            mouseEvents += '</optgroup>';
            mouseEvents += '<optgroup label="Right">';
            mouseEvents += '<option value="' + (-2147483648) + '">Right single</option>';
            mouseEvents += '<option value="' + 0x10000000 + '">Right double</option>';
            mouseEvents += '<option value="' + 0x02000000 + '">Right drag</option>';
            mouseEvents += '<option value="' + 0x00080000 + '">Right release</option>';
            mouseEvents += '</optgroup>';
            mouseEvents += '<optgroup label="Middle">';
            mouseEvents += '<option value="' + 0x40000000 + '">Middle single</option>';
            mouseEvents += '<option value="' + 0x08000000 + '">Middle double</option>';
            mouseEvents += '<option value="' + 0x01000000 + '">Middle drag</option>';
            mouseEvents += '<option value="' + 0x00040000 + '">Middle release</option>';
            mouseEvents += '</optgroup>';
            mouseEvents += '<optgroup label="Wheel">';
            mouseEvents += '<option value="' + 0x00010000 + '">Wheel flip</option>'; // look at next 2 rect for mouse wheel commands
            mouseEvents += '<option value="' + 0x00004000 + '">Wheel up</option>';
            mouseEvents += '<option value="' + 0x00002000 + '">Wheel down</option>';
            mouseEvents += '</optgroup>';
            mouseEvents += '<option value="' + 0x00400000 + '">Move</option>';
            mouseEvents += '<option value="' + 0x00200000 + '">Down repeat</option>';
        
        
            function decimalToHex(d, padding) {
                var hex = Number(d).toString(16).toUpperCase();
                padding = typeof (padding) === "undefined" || padding === null ? padding = 2 : padding;
                while (hex.length < padding) hex = "0" + hex;
                return hex;
            }
        
            function programmingHint(typeIndex) {
                switch (typeIndex) {
                    case 0:
                        return "simulationData.asBool";
                        break;
                    case 1:
                        return "simulationData.asInt32";
                        break;
                    case 2:
                        return "simulationData.asDouble";
                        break;
                    case 3:
                        return "simulationData.asText";
                        break;
                    case 4:
                        return "simulationData.asLLA.latitude<br/>simulationData.asLLA.longitude<br/>simulationData.asLLA.altitude";
                        break;
                    case 5:
                        return "simulationData.asPBH.pitch<br/>simulationData.asPBH.bank<br/>simulationData.asPBH.heading";
                        break;
                    case 6:
                        return "simulationData.asXYZ.x<br/>simulationData.asXYZ.y<br/>simulationData.asXYZ.z";
                        break;
                    default:
                        return "?";
                        break;
                }
            }
            
        
            function cduScreenDatatoHtml() {
                FsTamTamCduScreenData.init();
                if (!FsTamTamCduScreenData.isPowered()) return "";
                var html = '<table class="cduscreen" cellspacing="0" cellpadding="0">';
                var col = 0;
                var row = 0;
                var info;
                var chCode;
                var ch;
                while ((info = FsTamTamCduScreenData.nextCell()) != null) {
                    if (col == 0) html += '<tr>';
                    html += FsTamTamCduTag(info);
                    chCode = info.asciiCode;
                    switch (chCode) {
                        case 0xa1:
                            html += "&larr;";
                            break;
                        case 0xa2:
                            html += "&rarr;";
                            break;
                        case 0xb0:
                            html += "&deg;";
                            break;
                        case 0xea:
                            html += '<img src="/img/square.png"/>';
                            break;
                        case 0x3a:
                            html += ":";
                            break;
                        case 0x7c:
                            html += "|";
                            break;
                        default:
                            ch = String.fromCharCode(chCode).charAt(0);
                            html += (ch != ' ') ? ch : '&nbsp;';
                            break;
                    }
                    html += '</td>';
                    col = ++col % 24;
                    if (col == 0) {
                        row++;
                        html += '</tr>';
                    }
                }
                return html + '</table>';
            }
        
            function sendParameter(domId, id) {
                var ref = document.getElementById(domId);
                if (ref == null) return;
                FsTamTam.sendData(id, ref.value);
            }

            function toggleParameter(domId, id) {
                var ref = document.getElementById(domId);
                if (ref == null) return;
                var v = (ref.value != 0) ? 0 : 1;
                ref.value = v;
                FsTamTam.sendData(id, ref.value);
            }
        
            function sendMouseFlag(domId, id) {
                var ref = document.getElementById(domId);
                if (ref == null || ref.selectedIndex < 0) return;
                FsTamTam.sendData(id, ref.options[ref.selectedIndex].value);
            }
        
            function pmdgNgxEventParameter(id) {
                var id1 = 'n' + id.trim();
                var id2 = 'm' + id.trim();
                var s = '<input id="' + id1 + '" type="number" step="1" value="-1"/><a onclick="sendParameter(\'' + id1 + '\', ' + id + ');">&#9654;</a>';
                s += '&nbsp;&nbsp;or<a onclick="toggleParameter(\'' + id1 + '\', ' + id + ')">Toggle </a>';
                s += '&nbsp;&nbsp;or Mouse Flag&nbsp;&nbsp;';
                s += '<select id="m' + id + '">' + mouseEvents + '</select><a onclick="sendMouseFlag(\'' + id2 + '\', ' + id + ');">&#9654;</a>';
                return s;
            }
        
            function simconnectParameter(id) {
                var id1 = 'n' + id.trim();
                var s = '<input id="' + id1 + '" type="number" step="1" value="0"/><a onclick="sendParameter(\'' + id1 + '\', ' + id + ');">&#9654;</a>';
                s += '&nbsp;&nbsp;or<a onclick="toggleParameter(\'' + id1 + '\', ' + id + ')">Toggle </a>';
                return s;
            }

            function globalVariableParameter(id) {
                var id1 = 'g' + (-id * 1);
                var s = '<input id="' + id1 + '" type="number" step="1" value="0"/><a onclick="sendParameter(\'' + id1 + '\', ' + id + ');">&#9654;</a>';
                s += '&nbsp;&nbsp;or<a onclick="toggleParameter(\'' + id1 + '\', ' + id + ')">Toggle </a>';
                return s;
            }


            function renderTools() {
                if (refTools == null) refTools = document.getElementById("toolscnt");
                switch (state) {
                    case __SIMCONNECT_VARIABLES:
                    case __SIMCONNECT_EVENTS:
                    case __PMDG_NGX_VARIABLES:
                    case __PMDG_NGX_EVENTS:
                    case __GLOBAL_VARIABLES:
                        refTools.classList.remove("hide");
                        break;
                    case __NONE:
                    case __SYSTEM_INFO:
                    case __OPERATIONS:
                    case __LISTS:
                        refTools.classList.add("hide");
                        break;
                }
            }
        
        
            function renderStage(){
                var ref;
                var refs;
                var level = 0;
                if (connected) level = 1;
                if (simulator != '-') level = 2;
                if (FsTamTam.modelName() != "") level = 3;
                
                ref = document.getElementById("fstamtam");
                refs = document.getElementById("stage1");
                if (level == 0) {
                    ref.innerHTML = 'Trying to reconnect';
                    refs.style.backgroundColor = "#f00";
                } else {
                    ref.innerHTML = 'Connected';
                    refs.style.backgroundColor = "#0a0";
                }
                ref = document.getElementById("simulator");
                refs = document.getElementById("stage2");
                if (level < 1) {
                    ref.innerHTML = '';
                    refs.style.backgroundColor = "#32323c";
                } else {
                    ref.innerHTML = (level < 2) ? 'Trying to connect' : simulator;
                    refs.style.backgroundColor = (level < 2) ? "#f90" : "#0a0";
                }
                ref = document.getElementById("simulation");
                refs = document.getElementById("stage3");
                if (level < 2) {
                    ref.innerHTML = '';
                    refs.style.backgroundColor = "#32323c";
                } else {
                    if (level < 3) {
                        ref.innerHTML = 'Not started';
                        refs.style.backgroundColor = "#f90";
                    } else {
                        ref.innerHTML = (FsTamTam.isPmdgNgxModel() ? 'PMDG-NGX' : "Standard") + ' model</span><br/>"' + FsTamTam.modelName() + '"';
                        refs.style.backgroundColor = "#0a0";
                    }
                }                    
            }
        
        
            function renderMenu() {
                var dis = "disabled";
                var sel = "selected";
                var refs = document.getElementById("menu").getElementsByTagName("td");
                if (!connected) {
                    for (var i = 0; i < refs.length; i++) {
                        refs[i].classList.remove(sel);
                        refs[i].classList.add(dis);
                    }
                    refs[6].style.color = refs[7].style.color = "";
                    return;
                }
                for (var i = 0; i < refs.length; i++) {
                    refs[i].classList.remove(sel);
                    if (i < 7) refs[i].classList.remove(dis);
                    if (i == __OPERATIONS) {
                        if (simulationRunning) {
                            refs[__OPERATIONS].classList.remove(dis);
                            refs[__LISTS].classList.remove(dis);
                            if (state == __OPERATIONS) {
                                refs[__OPERATIONS].classList.add(sel);
                                refs[__LISTS].classList.add(sel);
                            }
                        } else {
                            refs[__OPERATIONS].classList.add(dis);
                            refs[__LISTS].classList.add(dis);
                        }
                    }
                }
                refs[7].style.color = refs[6].style.color = simulationRunning ? "#0f0" : "";
                if (state != __OPERATIONS)
                    refs[state].classList.add(sel);
            }
        
        
            function refreshProbed() {
                
                if (!showProbesOnly) return;
                var ref = document.getElementById(tableName);
                if (ref == null) return;
                var rows = ref.rows;
                for (var i = 1; i < rows.length; i++) {
                    ref = rows[i];
                    if (!ref.classList.contains("probe")) ref.style.display = "none";
                }
            }
        
        
            function manageClick(ref, id) {
                ref = ref.parentElement.parentElement;
                var probed = ref.classList.contains("probe");
                var xhr;
                var ref2;
                var isEvent = state == __SIMCONNECT_EVENTS || state == __PMDG_NGX_EVENTS;
                if (probed) {
                    ref.classList.remove("probe");
                    xhr = new XMLHttpRequest();
                    xhr.open("GET", "/function/probes/" + tableName + "/delete/" + id);
                    xhr.onload = function() {
                        if (this.status != 200) return;
                        manageShowMode(false);
                    };
                    xhr.send();
                } else {
                    ref.classList.add("probe");
                    xhr = new XMLHttpRequest();
                    xhr.open("GET", "/function/probes/" + tableName + "/add/" + id);
                    xhr.onload = function() {};
                    xhr.send();
                }
            }    
        
        
            function removeProbe(ref, id, isVar, minIdx, maxIdx) {
                var loc;
                if (state != __OPERATIONS || ref == null) return;
                if (id < 0) {
                    id = -id;
                    loc = "global-variables";
                    FsTamTam.sendRawCommand("DG" + id);
                } else
                if (id > PMDG_NGX_ID_OFFSET) {
                    id = id - PMDG_NGX_ID_OFFSET;
                    loc = (isVar) ? "pmdg-ngx-variables" : "pmdg-ngx-events";
                    FsTamTam.sendRawCommand("DP" + id);
                } else {
                    loc = (isVar) ? "simconnect-variables" : "simconnect-events";
                    if (isVar) {
                        if (id < 2000) {
                            FsTamTam.sendRawCommand("DS" + id);
                        } else {
                            if (minIdx < 0) minIdx = 0;
                            if (maxIdx < 0) maxIdx = 9;
                            for (var i = minIdx; i <= maxIdx; i++)
                                FsTamTam.sendRawCommand("DS" + id + ":" + i);
                        }
                    }
                }
                ref.parentElement.parentElement.classList.add("hide");
                var xhr = new XMLHttpRequest();
                xhr.open("GET", "/function/probes/" + loc + "/delete/" + id);
                xhr.onload = function() {};
                xhr.send();
            }
        
                
            function removeAllProbes() {
                if (simulationRunning)
                    switch (state) {
                        case __OPERATIONS:
                            if (FsTamTam.isPmdgNgxModel()) FsTamTam.sendRawCommand("DPA");
                            FsTamTam.sendRawCommand("DSA");
                            FsTamTam.sendRawCommand("DGA");
                            break;
                    }
                var xhr = new XMLHttpRequest()
                xhr.open("GET", "/function/probes/" + tableName + "/delete/all");
                xhr.onload = function() {
                    if (this.status != 200) return;
                    var rows = document.getElementById(tableName).getElementsByClassName("probe");
                    var len = rows.length;
                    for (var i = 0; i < len; i++) rows[0].classList.remove("probe");
                    showProbesOnly = false;
                    manageShowMode(false);
                };
                xhr.send();
            }
        
        
            function processEvent(id, probed) {
                if (!probed) return '-';
                if (!simulationRunning) return '&lt; wait for simulation to start &gt;';
                var s;
                if (probed) {
                    switch (state) {
                        case __PMDG_NGX_EVENTS:
                            s = pmdgNgxEventParameter(id);
                            break;
                        case __SIMCONNECT_EVENTS:
                            s = simConnectEventParameter(id);
                            break;
                    }
                } else 
                    s = "-";
                return s;
            }
        

            function preparePage() {                
                if (!refContent) refContent = document.getElementById("content");
                if (!refSearch) refSearch = document.getElementById("search");
                if (state == __NONE) 
                    refContent.classList.add('hide');
                else
                    if (state != __LISTS) refContent.classList.remove('hide');
                refSearch.value = "";
                refSearch.style.backgroundColor = "";
                renderMenu();
                renderTools();
                refContent.style.paddingTop = (document.getElementById("header").clientHeight) + 'px';
                refreshProbed();
            }
        
        
            function reloadSystemInfo() {
                if (state != __SYSTEM_INFO || !connected) {
                    if (systemInfoInterval != -1) clearInterval(systemInfoInterval);
                    systemInfoInterval = -1;
                    return;
                }
                setView("system-info");
            }
        
        
            function loadSystemInfo() {
                if (this.status != 200) return;
                var e = this.responseText.split("@");
                var e2;
                var s2 = "";
                var s = '<table class="system-info"><tbody>';
                s += '<tr><td colspan="2"><h2 class="title">FsTamTam server</h2></td></tr>';
                e2 = e[1].split("|");
                for (var i = 1; i < e2.length; i += 2) 
                    s += '<tr><td>' + e2[i] + '&nbsp;&nbsp;</td><td>' + e2[i + 1] + '</td></tr>'
                s += '<tr><td colspan="2"><h2 class="title">Simulator</h2></td></tr>';
                e2 = e[0].split("|");
                for (var i = 1; i < e2.length; i += 2) 
                    s += '<tr><td>' + e2[i] + '&nbsp;&nbsp;</td><td>' + e2[i + 1] + '</td></tr>'
                e2 = e[2].split("|");
                if (e2.length <= 1) {
                    s += '<tr><td colspan="2"><h2 class="title">FsTamTam device connections (0)</h2></td></tr>';
                } else {
                    var numOfDevices = (e2.length - 1) / 8;
                    var idx = 1;
                    s += '<tr><td colspan="2"><h2 class="title">FsTamTam device connections (' + numOfDevices + ')</h2></td></tr>';
                    for (var i = 0; i < numOfDevices; i++) {
                        if (i > 0) {
                            s += '<tr><td colspan="2"><hr/></td></tr>';
                        }
                        idx++;
                        s2 ="";
                        s += '<tr><td>' + e2[idx++] + '</td><td><table class="system-info"><tbody>';
                        for (var j = 2; j < 8; j += 2) {
                            s2 += '<tr><td>' + e2[idx++] + '</td><td>' + e2[idx++] + '</td></tr>';
                        }
                        s += s2 + '</tbody></table></td></tr>'
                    }
                }
                s += "</tbody></table></div>";
                refContent.innerHTML = s;
                state = __SYSTEM_INFO;
                preparePage();    
                if (systemInfoInterval == -1)
                    systemInfoInterval = setInterval(reloadSystemInfo, 2000);
            }
        
        
            function loadSimConnectEvents() {
                if (this.status != 200) return;
                state = __SIMCONNECT_EVENTS;
                var s = '<table class="list" id="' + tableName + '"><thead>';
                s += '<th colspan="2">Name</th>';
                s += '<th>Notes</th>';
                s += '</thead><tbody id="' + tableName + '-body">';
                var e = this.responseText.split('@');
                for (var i = 0; i < e.length; i++) {
                    if (e[i] == "") continue;
                    var e2 = e[i].split('|');
                    e2[1] = e2[1].replaceAll("#", "<br/>");
                    e2[2] = e2[2].replaceAll("#", "<br/>");
                    s += '<tr class="' + ((e2[3] == '*') ? 'probe' : '') + '" id="' + e2[1].toLowerCase() + '">';
                    s += '<td>⬤</td>';
                    s += '<td><span onclick="manageClick(this,' + e2[0] + ')">' + e2[1] + '</span></td>';
                    s += '<td class="notes">' + e2[2] + '</td>';
                    s += "</tr>";
                }
                s += "</tbody></table>";
                refContent.innerHTML = s;
                preparePage();    
            }

        
            function loadSimConnectVariables() {
                if (this.status != 200) return;
                state = __SIMCONNECT_VARIABLES;
                var s = '<table class="list variables" id="' + tableName + '"><thead>';
                s += '<th colspan="2">Name</th>';
                s += "<th>Notes</th>";
                s += "<th>Type or Unit</th>";
                s += "<th>Programming hint</th>";
                s += '</thead><tbody id="' + tableName + '-body">';
                var e = this.responseText.split('@');
                for (var i = 0; i < e.length; i++) {
                    if (e[i] == "") continue;
                    var e2 = e[i].split('|');
                    e2[1] = e2[1].replaceAll("#", "<br/>");
                    e2[4] = e2[4].replaceAll("#", "<br/>");
                    var id = e2[0] * 1;
                    var arr = id > 2000;
                    s += '<tr class="' + ((e2[5] == '*') ? 'probe' : '') + '" id="' + e2[1].toLocaleLowerCase() + '">';
                    e2[1] = e2[1].replaceAll("#", "<br/>");
                    s += '<td>⬤</td><td>';
                    s += '<span onclick="manageClick(this,' + e2[0] + ')">' + e2[1] + '</span>';
                    if (arr) {
                        var minIdx = e2[6] * 1;
                        var maxIdx = e2[7] * 1;
                        s += '&nbsp;&nbsp;<span class="arraylabel">array [' + minIdx + '..' + ((maxIdx >= 0) ? maxIdx : ' 9 (max)') + ']</span>';
                    }
                    s += '</td>';
                    s += '<td class="notes">' + e2[4] + '</td>';
                    s += '<td class="type">' + e2[2] + '</td>';
                    s += '<td class="phint">' + programmingHint(e2[3] * 1) + '</td>';
                    s += "</tr>";
                }
                s += "</tbody></table>";
                refContent.innerHTML = s;
                preparePage();    
            }

        
            function loadPmdgNgxEvents() {
                if (this.status != 200) return;
                state = __PMDG_NGX_EVENTS;
                var s = '<table class="list" id="' + tableName + '"><thead>';
                s += '<th colspan="2">Name</th>';
                s += "<th>Notes</th>";
                s += '</thead><tbody id="' + tableName + '-body">';
                var e = this.responseText.split('@');
                for (var i = 0; i < e.length; i++) {
                    if (e[i] == "") continue;
                    var e2 = e[i].split('|');
                    e2[1] = e2[1].replaceAll("#", "<br/>");
                    e2[2] = e2[2].replaceAll("#", "<br/>");
                    s += '<tr class="' + ((e2[3] == '*') ? 'probe' : '') + '" id="' + e2[1].toLowerCase() + '">';
                    s += '<td>⬤</td>';
                    s += '<td><span onclick="manageClick(this,' + e2[0] + ')">' + e2[1] + '</span></td>';
                    s += '<td class="notes">' + e2[2] + '</td>';
                    s += "</tr>";
                }
                s += "</tbody></table>";
                refContent.innerHTML = s;
                preparePage();    
            }

        
            function loadPmdgNgxVariables() {
                if (this.status != 200) return;
                state = __PMDG_NGX_VARIABLES;
                var s = '<table class="list variables" id="' + tableName + '"><thead>';
                s += '<th colspan="2">Name</th>';
                s += "<th>Notes</th>";
                s += "<th>Type</th>";
                s += "<th>Programming hint</th>";
                s += '</thead><tbody id="' + tableName + '-body">';
                var e = this.responseText.split('@');
                for (var i = 0; i < e.length; i++) {
                    if (e[i] == "") continue;
                    var e2 = e[i].split('|');
                    e2[1] = e2[1].replaceAll("#", "<br/>");
                    e2[4] = e2[4].replaceAll("#", "<br/>");
                    s += '<tr class="' + ((e2[5] == '*') ? 'probe' : '') + '" id="' + e2[1].toLowerCase() + '">';
                    s += '<td>⬤</td>';
                    s += '<td><span onclick="manageClick(this,' + e2[0] + ')">' + e2[1] + '</span></td>';
                    s += '<td class="notes">' + e2[4] + '</td>';
                    s += '<td class="type">' + e2[2] + '</td>';
                    s += '<td class="phint">' + programmingHint(e2[3] * 1) + '</td>';
                    s += "</tr>";
                }
                s += "</tbody></table>";
                refContent.innerHTML = s;
                preparePage();    
            }

        
            function loadGlobalVariables() {
                if (this.status != 200) return;
                state = __GLOBAL_VARIABLES;
                var s = '<table class="list variables" id="' + tableName + '"><thead>';
                s += '<th colspan="2">Name</th><th>Type</th><th>Programming hint</th>';
                s += '</thead><tbody id="' + tableName + '-body">';
                var e = this.responseText.split('@');
                for (var i = 0; i < e.length; i++) {
                    if (e[i] == "") continue;
                    var e2 = e[i].split('|');
                    s += '<tr class="' + ((e2[2] == '*') ? 'probe' : '') + '" id="' + e2[1].toLowerCase() + '">';
                    s += '<td>⬤</td>';
                    s += '<td><span onclick="manageClick(this,' + e2[0] + ')">' + e2[1] + '</span></td><td>Number</td><td class="phint">simulationData.asInt32</td>';
                    s += "</tr>";
                }
                s += "</tbody></table>";
                refContent.innerHTML = s;
                preparePage();    
            }
                

            function operationsSubscribeData() {
                // subscribe data
                var e = reqs.split('|');
                var id2;
                var e2;
                if (e.length == 0) return;
                for (var i = 0; i < e.length; i++) {
                    if (e[i] == '') break;
                    e2 = e[i].split('#');
                    id2 = e2[0] * 1;
                    if (id2 < 0)
                        FsTamTam.subscribeData(id2);
                    else
                    if (id2 >= PMDG_NGX_ID_OFFSET)
                        FsTamTam.subscribeData(id2, DELIVER_ON_CHANGE);
                    else
                    if (id2 < 2000)
                        FsTamTam.subscribeData(id2, DELIVER_ON_CHANGE);
                    else
                        for (var j = (e2[1] * 1); j <= (e2[2] * 1); j++)
                            FsTamTam.subscribeData(id2, j, DELIVER_ON_CHANGE);
                }
            }
        
        
            function loadOperations() {
                if (this.responseText.length == 0) return;
                var st = 0;
                var i = 0;
                var n = 0;
                var id;
                var name;
                var description;
                var minIdx;
                var maxIdx;
                var svars = '';
                var sevts = '';
                var pvars = '';
                var pevts = '';
                var gvs = '';
                var vars = '';
                var evts = '';
                var code;
                reqs = '';
                var e = this.responseText.split('|');
                while (i < e.length) { 
                    switch (st) {
                        case 0:
                            code = e[i++];
                            if (code == 'simconnect-variables') {
                                n = e[i++] * 1;
                                if (n > 0) st = 1;
                            } else
                            if (code == 'pmdg-ngx-variables') {
                                n = e[i++] * 1;
                                if (n > 0) st = 2;
                            } else 
                            if (code == 'simconnect-events') {
                                n = e[i++] * 1;
                                if (n > 0) st = 3;
                            } else 
                            if (code == 'pmdg-ngx-events') {
                                n = e[i++] * 1;
                                if (n > 0) st = 4;
                            } else 
                            if (code == 'global-variables') {
                                n = e[i++] * 1;
                                if (n > 0) st = 5;
                            } else {
                                return;
                            }
                            break;
                        case 1: // svars
                            id = e[i++] * 1;
                            name = e[i++].replaceAll("#", "<br/>");
                            description = e[i++].replaceAll("#", "<br/>");
                            minIdx = e[i++] * 1;
                            maxIdx = e[i++] * 1;
                            reqs += id + '#' + minIdx + '#' + maxIdx + '|';
                            svars += '<tr><td><span>⬤</span></td><td><span onClick="removeProbe(this, ' + id + ', true, ' + minIdx +', ' + maxIdx + ')">' + name + '</span>';
                            if (id >= 2000)
                                svars += '&nbsp;&nbsp;<span class="arraylabel">array [' + minIdx + '..' + ((maxIdx >= 0) ? maxIdx : ' 9 (max)') + ']</span>';
                            svars += '</td><td id="vs' + id + '" class="value">&mdash;</td><td>' + description + '</td></tr>';
                            if (--n == 0) st = 0;
                            break;
                        case 2: // pvars
                            id = e[i++];
                            if (FsTamTam.isPmdgNgxModel()) reqs += id + '##|';
                            name = e[i++].replaceAll("#", "<br/>");
                            description = e[i++].replaceAll("#", "<br/>");
                            if (FsTamTam.isPmdgNgxModel())
                                pvars += '<tr><td><span>⬤</span></td><td><span onClick="removeProbe(this, ' + id + ', true)">' + name + '</span></td><td id="vp' + id + '" class="value">&mdash;</td><td>' + description + '</td></tr>';
                            else
                                pvars += '<tr><td>⬤</td><td><xx onClick="removeProbe(this, ' + id + ', true)">' + name + '</xx</td><td>✈ not a PMDG-NGX model</td><td>' + description + '</td></tr>';
                            if (--n == 0) st = 0;
                            break;
                        case 3: // sevts
                            id = e[i++];
                            name = e[i++].replaceAll("#", "<br/>");
                            description = e[i++].replaceAll("#", "<br/>");
                            sevts += '<tr class="param"><td><span>⬤</span></td><td><span onClick="removeProbe(this, ' + id + ', false)">' + name + '</span></td><td>' + simconnectParameter(id) + '</td><td>' + description + '</td></tr>';
                            if (--n == 0) st = 0;
                            break;
                        case 4: // pevts
                            id = e[i++];
                            name = e[i++].replaceAll("#", "<br/>");
                            description = e[i++].replaceAll("#", "<br/>");
                            if (FsTamTam.isPmdgNgxModel())
                                pevts += '<tr class="param"><td><span>⬤</span></td><td><span onClick="removeProbe(this, ' + id + ', false)">' + name + '</span></td><td>' + pmdgNgxEventParameter(id) + '</td><td>' + description + '</td></tr>';
                            else
                                pevts += '<tr><td>⬤</td><td><xx onClick="removeProbe(this, ' + id + ', false)">' + name + '</xx></td><td>✈ not a PMDG-NGX model</td><td>' + description + '</td></tr>';
                            if (--n == 0) st = 0;
                            break;
                        case 5: // gvs
                            id = e[i++];
                            reqs += id + '##|';
                            name = e[i++];
                            description = e[i++];
                            gvs += '<tr><td><span>⬤</span></td><td><span onClick="removeProbe(this, ' + id + ', true)">' + name + '</span></td><td class="param">' + globalVariableParameter(id) + '</td><td  class="value" id="vg' + (-id) + '">&mdash;</td></tr>';
                            if (--n == 0) st = 0;
                            break;
                    }
                }
                vars = svars + pvars;
                evts = sevts + pevts;
                if (vars.length > 0)
                    vars = '<table class="listops listvars"><tr><th colspan="2">Name</th><th>Value</th><th>Description</th></tr>' + vars + '</table>';
                else 
                    vars = '<div class="noprobes">No probes</div>';
                if (evts.length > 0) 
                    evts = '<table class="listops"><tr><th colspan="2">Name</th><th>Set Parameter &amp; Send</th><th>Description</th></tr>' + evts + '</table>';
                else 
                    evts = '<div class="noprobes">No probes</div>';
                if (gvs.length > 0) 
                    gvs = '<table class="listops listglobals"><tr><th colspan="2">Name</th><th>Set Value &amp; Send</th><th>Value on FsTamTam server</th></tr>' + gvs + '</table>';
                else 
                    gvs = '<div class="noprobes">No probes</div>';
                s  = '<div class="label">Click on names to remove probes</div>';
                s += '<div><h2 class="h2ops">&nbsp;&nbsp;<span>&#9992;</span>&nbsp;&nbsp;&#8594;&nbsp;&nbsp;FsTamTam</h2></div>';
                s += '<div>' + vars + '</div>';
                s += '<div><h2 class="h2ops">&nbsp;&nbsp;<span>&#9992;</span>&nbsp;&nbsp;&#8592;&nbsp;&nbsp;FsTamTam</h2></div>';
                s += '<div>' + evts + '</div>';
                s += '<div><h2 class="h2ops">&nbsp;&nbsp;FsTamTam Global Variables</h2></div>';
                s += '<div>' + gvs + '</div>';
                refContent.innerHTML = s;
                preparePage(); 
                setTimeout(operationsSubscribeData, 500);
            }
        
        
            function requestList(idx) {
                var ref = null;
                switch (idx) {
                    case 0:
                        ref = document.getElementById("aiwaypoints");
                        FsTamTam.requestAIWaypointList();
                        break;
                    case 1:
                        ref = document.getElementById("fairports");
                        FsTamTam.requestFacilityAirportList();
                        break;
                    case 2:
                        ref = document.getElementById("fwaypoints");
                        FsTamTam.requestFacilityWaypointList();
                        break;
                    case 3:
                        ref = document.getElementById("fndbs");
                        FsTamTam.requestFacilityNDBList();
                        break;
                    case 4:
                        ref = document.getElementById("fvors");
                        FsTamTam.requestFacilityVORList();
                        break;
                    case 5:
                        ref = document.getElementById("ftacans");
                        FsTamTam.requestFacilityTACANList();
                        break;
                }
                if (ref != null) ref.innerHTML = "";
            }
        
        
            function clearList(idx) {
                var ref = null;
                switch (idx) {
                    case 0:
                        ref = document.getElementById("aiwaypoints");
                        break;
                    case 1:
                        ref = document.getElementById("fairports");
                        break;
                    case 2:
                        ref = document.getElementById("fwaypoints");
                        break;
                    case 3:
                        ref = document.getElementById("fndbs");
                        break;
                    case 4:
                        ref = document.getElementById("fvors");
                        break;
                    case 5:
                        ref = document.getElementById("ftacans");
                        break;
                }
                if (ref != null) ref.innerHTML = "";
            }
        
        
            function clearAllLists() {
                for (var i = 0; i < 6; i++) clearList(i);
            }
        
        
            function loadLists() {
                if (refContent == null) refContent = document.getElementById("content");
                if (refDataLists == null) refDataLists = document.getElementById("datalists");
                refContent.innerHTML = "";
                refContent.classList.add("hide");
                refDataLists.classList.remove("hide");
                preparePage(); 
            }
        
        
            function search(input) {
                showProbesOnly = false;
                refShowMode.classList.remove("showall");
                refShowMode.classList.add("showsome");
                var str = input.value.toLowerCase().trim();
                input.style.backgroundColor = "";
                var rows = document.getElementById(tableName).rows;
                if (rows == null) return;
                var len = rows.length;
                if (str == null || str.length < 1) {
                    // show all
                    for (var i = 0; i < len; i++)
                        rows[i].style.display = "";
                    input.style.backgroundColor = "";
                    return;
                }
                var n = 0;
                var ref;
                var str2;
                for (var i = 1; i < len; i++) { // 1 skip the header
                    ref = rows[i];
                    str2 = ref.innerHTML.toLocaleLowerCase().replaceAll("<", "&lt;").replaceAll(">", "&gt;");
                    if (str2.includes(str)) {
                        rows[i].style.display = "";
                        n++;
                    } else
                        rows[i].style.display = "none";
                }
                window.scrollTo(0,0);
                input.style.backgroundColor = (n == 0) ? "#d00" : "#00ffff88";
                refContent.style.display = (n == 0) ? "none" : "";
            }

        
            function manageShowMode(change) {
                if (change) showProbesOnly = !showProbesOnly;
                if (showProbesOnly) {
                    refShowMode.classList.add("showall");
                    refShowMode.classList.remove("showsome");
                } else {
                    refShowMode.classList.remove("showall");
                    refShowMode.classList.add("showsome");
                }
                refSearch.value = "";
                refSearch.style.backgroundColor = "";
                var ref;
                var rows = document.getElementById(tableName).rows;
                if (rows == null || rows.length == 0) {
                    //refContent.style.display = "none";
                    return;
                }
                var visible = 0;
                for (var i = 0; i < rows.length; i++) {
                    ref = rows[i];
                    if (showProbesOnly && ref.id != "") {
                        if (ref.classList.contains("probe")) {
                            ref.style.display = "";
                            visible++;
                        } else {
                            ref.style.display = "none";
                        }
                    } else {
                        ref.style.display = "";
                        visible++;
                    }
                }
                refContent.style.display = (visible <= 1) ? "none" : "";
            }
        
        
            function setView(menuItem) {
                if (refContent == null) refContent = document.getElementById("content");
                if (refShowMode == null) refShowMode = document.getElementById("showmode");
                if (refSearch == null) refSearch = document.getElementById("search");
                if (refDataLists == null) refDataLists = document.getElementById("datalists");
                refDataLists.classList.add('hide');
                if (!(typeof(menuItem) !== 'undefined') || !connected) {
                    state = __NONE;
                    refContent.innerHTML = "";
                    refContent.style.display = "none";
                    preparePage();
                    return;
                }
                menuItem = menuItem.replace("btn-", "");
                tableName = menuItem;
                if (!simulationRunning && tableName == 'operations')
                    return;
                if (simulationRunning && state == __OPERATIONS) {
                    if (FsTamTam.isPmdgNgxModel()) FsTamTam.sendRawCommand("DPA");
                    FsTamTam.sendRawCommand("DSA");
                    FsTamTam.sendRawCommand("DGA");
                }
                var newState;
                if (tableName == "simconnect-variables") newState = __SIMCONNECT_VARIABLES;
                else
                if (tableName == "simconnect-events") newState = __SIMCONNECT_EVENTS;
                else
                if (tableName == "pmdg-ngx-variables") newState = __PMDG_NGX_VARIABLES;
                else
                if (tableName == "pmdg-ngx-events") newState = __PMDG_NGX_EVENTS;
                else
                if (tableName == "global-variables") newState = __GLOBAL_VARIABLES;
                else
                if (tableName == "system-info") newState = __SYSTEM_INFO;
                else
                if (tableName == "operations") newState = __OPERATIONS;
                else
                if (tableName == "lists") newState = __LISTS;
                else {
                    newState = __NONE;
                    return;
                }
                state = __NONE;
                var callback = null;
                switch (newState) {
                    case __SYSTEM_INFO:
                        callback = loadSystemInfo;
                        break;
                    case __PMDG_NGX_EVENTS:
                        callback = loadPmdgNgxEvents;
                        break;
                    case __PMDG_NGX_VARIABLES:    
                        callback = loadPmdgNgxVariables;
                        break;
                    case __SIMCONNECT_EVENTS:
                        callback = loadSimConnectEvents;
                        break;
                    case __SIMCONNECT_VARIABLES:
                        callback = loadSimConnectVariables;
                        break;
                    case __GLOBAL_VARIABLES:
                        callback = loadGlobalVariables;
                        break;
                    case __OPERATIONS:
                        callback = loadOperations;
                        break;
                    case __LISTS:
                        callback = null;
                        break;
                    default:
                        tableName = "";
                        callback = null;
                        state = __NONE;
                        return;
                }
                state = newState;
                window.scrollTo(0,0);
                refContent.style.display = "";
                if (state == __LISTS) {
                    loadLists();
                } else {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "/function/" + tableName);
                    xhr.onload = callback;
                    xhr.send();    
                }
            }
        
        
            function renderStruct() {
                var s = "";
                for (var i = 0; i < arguments.length; i += 2) {
                    s += arguments[i] + ':<span class="value">' + arguments[i + 1] + '</span> ';
                }
                return s;
            }
        
        
        
            function renderValue(data) {
                var s;
                switch (data.type) {
                    case DATA_TYPE_BOOLEAN:
                        return data.asBool ? '<span class="green">TRUE</span>' : '<span class="red">FALSE</span>';
                    case DATA_TYPE_INTEGER:
                        return '<span class="value">' + data.asInt32 + '</span>';
                    case DATA_TYPE_DOUBLE:
                        return '<span class="value">' + data.asDouble + '</span>';
                    case DATA_TYPE_TEXT:
                        return '<span class="valuestring value">' + data.asText.replaceAll(' ', '&nbsp;') + '</span>';
                    case DATA_TYPE_LLA:
                        return renderStruct(
                            'latitude', data.asLLA.latitude,
                            'longitude', data.asLLA.longitude,
                            'altitude', data.asLLA.altitude
                        );
                    case DATA_TYPE_PBH:
                        return renderStruct(
                            'pitch', data.asPBH.pitch,
                            'bank', data.asPBH.bank,
                            'heading', data.asPBH.heading
                        );
                    case DATA_TYPE_XYZ:
                        return renderStruct(
                            'x', data.asXYZ.x,
                            'y', data.asXYZ.y,
                            'z', data.asXYZ.z
                        );
                    case DATA_TYPE_AI_WAYPOINT:
                        return renderStruct(
                            'index', '' + data.asAIWaypoint.index + '/' + data.asAIWaypoint.outOf,
                            'latitude', data.asAIWaypoint.latitude,
                            'longitude', data.asAIWaypoint.longitude,
                            'altitude', data.asAIWaypoint.altitude,
                            'flags', '0x' + decimalToHex(data.asAIWaypoint.flags, 8),
                            'ktsSpeed', data.asAIWaypoint.ktsSpeed,
                            'percentThrottle', data.asAIWaypoint.percentThrottle
                        );
                    case DATA_TYPE_FACILITY_AIRPORT:
                        return renderStruct(
                            'index', '' + data.asFacilityAirport.index + '/' + data.asFacilityAirport.outOf,
                            'icao', data.asFacilityAirport.icao,
                            'latitude', data.asFacilityAirport.latitude,
                            'longitude', data.asFacilityAirport.longitude,
                            'altitude', data.asFacilityAirport.altitude
                        );
                    case DATA_TYPE_FACILITY_WAYPOINT:
                        return renderStruct(
                            'index', '' + data.asFacilityWaypoint.index + '/' + data.asFacilityWaypoint.outOf,
                            'icao', data.asFacilityWaypoint.icao,
                            'latitude', data.asFacilityWaypoint.latitude,
                            'longitude', data.asFacilityWaypoint.longitude,
                            'altitude', data.asFacilityWaypoint.altitude,
                            'magVar', data.asFacilityWaypoint.magVar
                        );
                    case DATA_TYPE_FACILITY_NDB:
                        return renderStruct(
                            'index', '' + data.asFacilityNDB.index + '/' + data.asFacilityNDB.outOf,
                            'icao', data.asFacilityNDB.icao,
                            'latitude', data.asFacilityNDB.latitude,
                            'longitude', data.asFacilityNDB.longitude,
                            'altitude', data.asFacilityNDB.altitude,
                            'magVar', data.asFacilityNDB.magVar,
                            'frequency', data.asFacilityNDB.frequency
                        );
                    case DATA_TYPE_FACILITY_VOR:
                        return renderStruct(
                            'index', '' + data.asFacilityVOR.index + '/' + data.asFacilityVOR.outOf,
                            'icao', data.asFacilityVOR.icao,
                            'latitude', data.asFacilityVOR.latitude,
                            'longitude', data.asFacilityVOR.longitude,
                            'altitude', data.asFacilityVOR.altitude,
                            'magVar', data.asFacilityVOR.magVar,
                            'frequency', data.asFacilityVOR.frequency,
                            'flags', '0x' + decimalToHex(data.asFacilityVOR.flags, 8),
                            'localizer', data.asFacilityVOR.localizer,
                            'glideLat', data.asFacilityVOR.glideLat,
                            'glideLon', data.asFacilityVOR.glideLon,
                            'glideAlt', data.asFacilityVOR.glideAlt,
                            'glideSlopeAngle', data.asFacilityVOR.glideSlopeAngle
                        );
                    case DATA_TYPE_FACILITY_TACAN:
                        return renderStruct(
                            'index', '' + data.asFacilityTACAN.index + '/' + data.asFacilityTACAN.outOf,
                            'icao', data.asFacilityTACAN.icao,
                            'latitude', data.asFacilityTACAN.latitude,
                            'longitude', data.asFacilityTACAN.longitude,
                            'altitude', data.asFacilityTACAN.altitude,
                            'magVar', data.asFacilityTACAN.magVar,
                            'channel', data.asFacilityTACAN.channel,
                            'xyBandIsY', data.asFacilityTACAN.xyBandIsY
                        );
                    default:
                        return '?';
                }
            }
        
        
            //
            // FsTamTam callbacks
            //
        
                    
            FsTamTam.onConnect = function() {
                if (simulatorNameInterval == -1) simulatorNameInterval = setInterval(function () {
                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "/function/simulator");
                    xhr.onload = function () {
                        if (this.status != 200) return;
                        simulator = this.responseText;
                        renderStage();
                    };
                    xhr.send();    
                }, 1000);
                connected = true;
                simulationRunning = false;
                simulator = "";
                clearAllLists();
                setView("system-info");
            }


            FsTamTam.onSimulationStart = function() {
                FsTamTam.joinSimulation();
                simulationRunning = true;
                setView("system-info");
            }


            FsTamTam.onSimulationData = function() {
                var ref = null;
                var s = '';
                var s2 = '';
                var id2;
                var len;
                var ratio;
                switch (state) {
                    case __OPERATIONS:
                        if (FsTamTam.simulationData.id > PMDG_NGX_ID_OFFSET) {
                            // pmdg ngx var
                            ref = document.getElementById('vp' + FsTamTam.simulationData.id);
                            if (ref == null) return;
                            id2 = FsTamTam.simulationData.id - PMDG_NGX_ID_OFFSET;
                            if (id2 < 1000)
                                // normal data
                                s = renderValue(FsTamTam.simulationData);
                            else {
                                // CDU screen data
                                s = '';
                                s = cduScreenDatatoHtml();
                                if (s == '') s = '<div class="red">NOT POWERED</div>';
                                len = FsTamTamCduScreenData.length();
                                ratio = 1009.0 / Math.max(1, len);
                                s += renderStruct('fstamtam-data-frame', len + ' bytes') + '<br/>';
                                s += renderStruct('pmdg-ngx-data-frame', '1009 bytes') + '<br/>';
                                s += renderStruct('compression-ratio', '1:' + + ratio.toFixed(0));
                            }
                            ref.innerHTML = s;
                        } else
                        if (FsTamTam.simulationData.id < 0) {
                            // global var
                            ref = document.getElementById('vg' + (-FsTamTam.simulationData.id));
                            if (ref == null) return;
                            s = FsTamTam.simulationData.asInt32;
                            ref.innerHTML = s;
                        } else {
                            // simconnect var
                            ref = document.getElementById('vs' + FsTamTam.simulationData.id);
                            if (ref == null) return;
                            if (FsTamTam.simulationData.id < 2000) {
                                s = renderValue(FsTamTam.simulationData);
                                ref.innerHTML = s;
                            } else 
                            if (ref.innerHTML.length < 10 /* a table is longer */) {
                                s = '<table id="' + FsTamTam.simulationData.id + 't">';
                                for (var i = 0; i < 10; i++) {
                                    if (i == FsTamTam.simulationData.index)
                                        s += '<tr style="display:block;"><td>[' + i + '] =</td><td>' + renderValue(FsTamTam.simulationData) + '</td></tr>';
                                    else
                                        s += '<tr style="display:none;"><td></td><td></td></tr>';
                                }
                                s += '</table>';
                                ref.innerHTML = s;
                            } else {
                                ref = ref.getElementsByTagName("tr");
                                ref = ref[FsTamTam.simulationData.index];
                                ref.style.display = "block";
                                ref = ref.getElementsByTagName("td");
                                ref[0].innerHTML = '[' + FsTamTam.simulationData.index + '] =';
                                ref[1].innerHTML = renderValue(FsTamTam.simulationData);
                            }
                        }
                        break;
                    case __LISTS:
                        switch (FsTamTam.simulationData.type) {
                            case DATA_TYPE_AI_WAYPOINT:
                                ref = document.getElementById('aiwaypoints');
                                break;
                            case DATA_TYPE_FACILITY_AIRPORT:
                                ref = document.getElementById('fairports');
                                break;
                            case DATA_TYPE_FACILITY_WAYPOINT:
                                ref = document.getElementById('fwaypoints');
                                break;
                            case DATA_TYPE_FACILITY_NDB:
                                ref = document.getElementById('fndbs');
                                break;
                            case DATA_TYPE_FACILITY_VOR:
                                ref = document.getElementById('fvors');
                                break;
                            case DATA_TYPE_FACILITY_TACAN:
                                ref = document.getElementById('ftacans');
                                break;
                        }
                        ref.innerHTML += '<div class="listele">' + renderValue(FsTamTam.simulationData) + '</div>';
                        break;
                }
            }


            FsTamTam.onSimulationStop = function() {
                simulationRunning = false;
                clearAllLists();
                renderStage();
                setView("system-info");
            }


            FsTamTam.onDisconnect = function() {
                if (simulatorNameInterval != -1) {
                    clearInterval(simulatorNameInterval);
                    simulatorNameInterval = -1;
                }
                if (systemLogInterval != -1) {
                    clearInterval(systemLogInterval);
                    systemLogInterval = -1;
                }
                connected = false;
                simulationRunning = false;
                simulator = "-";
                clearAllLists();
                renderStage();
                setView();
            }

            
            function init() {
                connected = false;
                simulationRunning = false;
                simulator = "-";
                document.getElementById('logolabel').innerHTML = '&copy; 2018-' + ((new Date()).getYear() + 1900) + ' iacopo baroncini';
                renderMenu();
                renderStage();
                FsTamTam.begin("FSTAMTAM CONSOLE");
                setView();
            }

        </script>
</head>
<body onload="init()">
    <div id="logo"><div><img src="img/logo.png"/></div><div id="logolabel"></div></div>
    <div id="page">
        <div id="header">
            <div class="statecnt">
                <table class="state">
                    <!--
                    <tr class="stateline">
                        <td colspan="5"><hr/></td>
                    </tr>
                    -->
                    <tr>
                        <th><span id="stage1">1</span></th>
                        <th>&#8644;</th>
                        <th><span id="stage2">2</span></th>
                        <th>&#9992;</th>
                        <th><span id="stage3">3</span></th>
                    </tr>
                    <tr>
                        <td>
                            <div>FsTamTam server</div>
                            <div class="hl" id="fstamtam"></div>
                        </td>
                        <td></td>
                        <td>
                            <div>Simulator</div>
                            <div class="hl" id="simulator"></div>
                        </td>
                        <td></td>
                        <td>
                            <div>Simulation</div>
                            <div class="hl" id="simulation"></div>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="menu">
                <table>
                    <tr>
                        <th colspan="2"><div>FsTamTam</div></th>
                        <th colspan="2"><div>SimConnect</div></th>
                        <th colspan="2"><div>PMDG-NGX</div></th>
                        <th colspan="2"><div>Simulation</div></th>
                    </tr>
                    <tr>
                        <td id="btn-system-info" onclick="setView(this.id);">System Info</td>
                        <td id="btn-global-variables" onclick="setView(this.id);">Global Variables</td>
                        <td id="btn-simconnect-variables" onclick="setView(this.id);">Variables</td>
                        <td id="btn-simconnect-events" onclick="setView(this.id);">Events</td>
                        <td id="btn-pmdg-ngx-variables" onclick="setView(this.id);">Variables</td>
                        <td id="btn-pmdg-ngx-events" onclick="setView(this.id);">Events</td>
                        <td id="btn-operations" onclick="setView(this.id);">Operations</td>
                        <td id="btn-lists" onclick="setView(this.id);">Lists</td>
                    </tr>
                </table>
            </div>
            <div id="toolscnt" class="hide">
                <div id="tools">
                    <div>
                        <table>
                            <td>
                                <img src="img/search.png"><input id="search" type="text" onkeyup="search(this);">
                                <a id="showmode" class="showsome" onclick="manageShowMode(true);">Show probed only</a>
                                <span>Click on names to add / remove probes</span>
                            </td>
                            <td>
                                <a onclick="removeAllProbes();">Remove all probes</a>
                            </td>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div id="content" class="hide">
        </div>
        <div id="datalists">
            <table>
                <tr>
                    <th>List</th>
                    <th>Elements</th>
                    <th>Programming hint</th>
                </tr>                
                <tr>
                    <td>AI WAYPOINTs<br/> <br/><a onclick="requestList(0);">Request</a><a onclick="clearList(0);">Clear</a></td>
                    <td id="aiwaypoints"></td>
                    <td>
                        simulationData.asAIWaypoint.latitude<br/>
                        simulationData.asAIWaypoint.longitude<br/>
                        simulationData.asAIWaypoint.altitude<br/>
                        simulationData.asAIWaypoint.flags<br/>
                        simulationData.asAIWaypoint.ktsSpeed<br/>
                        simulationData.asAIWaypoint.percentThrottle
                    </td>
                </tr>
                <tr>
                    <td>FACILITY AIRPORTs<br/> <br/><a onclick="requestList(1);">Request</a><a onclick="clearList(1);">Clear</a></td>
                    <td id="fairports"></td>
                    <td>
                        simulationData.asFacilityAirport.icao<br/>
                        simulationData.asFacilityAirport.latitude<br/>
                        simulationData.asFacilityAirport.longitude<br/>
                        simulationData.asFacilityAirport.altitude
                    </td>
                </tr>
                <tr>
                    <td>FACILITY WAYPOINTs<br/> <br/><a onclick="requestList(2);">Request</a><a onclick="clearList(2);">Clear</a></td>
                    <td id ="fwaypoints"></td>
                    <td>
                        simulationData.asFacilityWaypoint.icao<br/>
                        simulationData.asFacilityWaypoint.latitude<br/>
                        simulationData.asFacilityWaypoint.longitude<br/>
                        simulationData.asFacilityWaypoint.altitude<br/>
                        simulationData.asFacilityWaypoint.magVar
                    </td>
                </tr>
                <tr>
                    <td>FACILITY NDBs<br/> <br/><a onclick="requestList(3);">Request</a><a onclick="clearList(3);">Clear</a></td>
                    <td id="fndbs"></td>
                    <td>
                        simulationData.asFacilityNDB.icao<br/>
                        simulationData.asFacilityNDB.latitude<br/>
                        simulationData.asFacilityNDB.longitude<br/>
                        simulationData.asFacilityNDB.altitude<br/>
                        simulationData.asFacilityNDB.magVar<br/>
                        simulationData.asFacilityNDB.frequency
                    </td>
                </tr>
                <tr>
                    <td>FACILITY VORs<br/> <br/><a onclick="requestList(4);">Request</a><a onclick="clearList(4);">Clear</a></td>
                    <td id="fvors"></td>
                    <td>
                        simulationData.asFacilityVOR.icao<br/>
                        simulationData.asFacilityVOR.latitude<br/>
                        simulationData.asFacilityVOR.longitude<br/>
                        simulationData.asFacilityVOR.altitude<br/>
                        simulationData.asFacilityVOR.magVar<br/>
                        simulationData.asFacilityVOR.frequency<br/>
                        simulationData.asFacilityVOR.flags<br/>
                        simulationData.asFacilityVOR.localizer<br/>
                        simulationData.asFacilityVOR.glideLat<br/>
                        simulationData.asFacilityVOR.glideLon<br/>
                        simulationData.asFacilityVOR.glideAlt<br/>
                        simulationData.asFacilityVOR.glideSlopeAngle
                    </td>
                </tr>
                <tr>
                    <td>FACILITY TACANs<br/> <br/><a onclick="requestList(5);">Request</a><a onclick="clearList(5);">Clear</a></td>
                    <td id="ftacans"></td>
                    <td>
                        simulationData.asFacilityTACAN.icao<br/>
                        simulationData.asFacilityTACAN.latitude<br/>
                        simulationData.asFacilityTACAN.longitude<br/>
                        simulationData.asFacilityTACAN.altitude<br/>
                        simulationData.asFacilityTACAN.magVar<br/>
                        simulationData.asFacilityTACAN.channel<br/>
                        simulationData.asFacilityTACAN.xyBandIsY
                    </td>
                </tr>
            </table>
        </div>
    </div>
</body>
</html>